#!/bin/bash

ANSIBLE_WRAPPER_DIR=$HOME/.ansible/wrapper
ANSIBLE_WRAPPER_DB=${ANSIBLE_WRAPPER_DIR}/execution_db
ANSIBLE_RUN_INSTANCE=`date +%Y-%m-%dT%H:%M:%S`
ANSIBLE_RUN_LOG="$ANSIBLE_WRAPPER_DIR/$ANSIBLE_RUN_INSTANCE/log"
ANSIBLE_RUN_TREE_BASE_DIR="$ANSIBLE_WRAPPER_DIR/$ANSIBLE_RUN_INSTANCE/tree"

mkdir -p "$ANSIBLE_WRAPPER_DIR/$ANSIBLE_RUN_INSTANCE"
mkdir -p "$ANSIBLE_WRAPPER_DIR/$ANSIBLE_RUN_INSTANCE/tree"

echo "${ANSIBLE_RUN_INSTANCE}:$*" >> $ANSIBLE_WRAPPER_DB
echo "${ANSIBLE_RUN_INSTANCE}" > $ANSIBLE_RUN_LOG
echo "Executing ansible -t $ANSIBLE_RUN_TREE_BASE_DIR $*" >> $ANSIBLE_RUN_LOG

(ansible -t "$ANSIBLE_RUN_TREE_BASE_DIR" "$@"; echo "Run complete" ) >> $ANSIBLE_RUN_LOG 2>&1 &

echo "The job is now running, the output log is $ANSIBLE_RUN_LOG"
